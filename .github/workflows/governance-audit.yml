name: Governance Audit Check

permissions:
  contents: read
  pull-requests: write

on:
  pull_request:
    branches: [main]
  workflow_dispatch:

jobs:
  audit-check:
    name: Verify Audit Trail
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Detect change class
        id: detect_class
        run: |
          # Get changed files
          git fetch origin ${{ github.base_ref }}
          CHANGED_FILES=$(git diff --name-only origin/${{ github.base_ref }}...HEAD)
          
          echo "Changed files:"
          echo "$CHANGED_FILES"
          
          # Determine if audit is required
          REQUIRES_AUDIT="false"
          CHANGE_CLASS="trivial"
          
          # Check for high-impact changes
          if echo "$CHANGED_FILES" | grep -qE "registries/|base120/validators/(mappings|errors|validate)\.py"; then
            REQUIRES_AUDIT="true"
            CHANGE_CLASS="fm"
          elif echo "$CHANGED_FILES" | grep -qE "schemas/|base120/validators/schema\.py"; then
            REQUIRES_AUDIT="true"
            CHANGE_CLASS="schema"
          elif echo "$CHANGED_FILES" | grep -qE "tests/corpus/"; then
            REQUIRES_AUDIT="true"
            CHANGE_CLASS="corpus"
          fi
          
          echo "requires_audit=$REQUIRES_AUDIT" >> $GITHUB_OUTPUT
          echo "change_class=$CHANGE_CLASS" >> $GITHUB_OUTPUT
          
          echo "Requires audit: $REQUIRES_AUDIT"
          echo "Change class: $CHANGE_CLASS"
      
      - name: Check for audit update
        if: steps.detect_class.outputs.requires_audit == 'true'
        run: |
          CHANGE_CLASS="${{ steps.detect_class.outputs.change_class }}"
          
          # Check if GOVERNANCE.md or CHANGELOG was updated
          git fetch origin ${{ github.base_ref }}
          AUDIT_FILES=$(git diff --name-only origin/${{ github.base_ref }}...HEAD | grep -E "GOVERNANCE\.md|CHANGELOG" || true)
          
          if [ -z "$AUDIT_FILES" ]; then
            echo "‚ö†Ô∏è WARNING: No audit update detected for $CHANGE_CLASS change"
            echo ""
            echo "Changes of class '$CHANGE_CLASS' require an audit trail update."
            echo "Please update one of the following:"
            echo "  - GOVERNANCE.md (add entry to Violation Handling or relevant section)"
            echo "  - CHANGELOG (if it exists)"
            echo ""
            echo "See GOVERNANCE.md Section: Invariants & Guarantees (Invariant 5)"
            
            # For now, this is a warning, not a hard failure
            # Uncomment the next line to make it a hard failure:
            # exit 1
          else
            echo "‚úÖ Audit update detected in:"
            echo "$AUDIT_FILES"
          fi
      
      - name: Check commit messages
        if: steps.detect_class.outputs.requires_audit == 'true'
        run: |
          # Check if commit messages reference issues or provide rationale
          git fetch origin ${{ github.base_ref }}
          COMMITS=$(git log --oneline origin/${{ github.base_ref }}...HEAD)
          
          echo "Commits in PR:"
          echo "$COMMITS"
          
          # Check if any commit references an issue (e.g., #19, issue #19)
          if echo "$COMMITS" | grep -qE "#[0-9]+|issue [0-9]+|fixes|closes"; then
            echo "‚úÖ Commit messages include issue references"
          else
            echo "‚ö†Ô∏è WARNING: No issue references found in commit messages"
            echo "Consider adding issue references for traceability"
          fi
      
      - name: Check PR description
        if: steps.detect_class.outputs.requires_audit == 'true' && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const changeClass = "${{ steps.detect_class.outputs.change_class }}";
            
            // Get PR description
            const pr = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number,
            });
            
            const description = pr.data.body || "";
            
            // Check for impact analysis keywords
            const hasImpact = /impact|rationale|justification|reason|because/i.test(description);
            const hasTestInfo = /test|corpus|validation/i.test(description);
            
            if (!hasImpact && changeClass !== 'trivial') {
              console.log("‚ö†Ô∏è WARNING: PR description may be missing impact analysis");
              console.log("Consider adding:");
              console.log("  - Rationale for the change");
              console.log("  - Impact on corpus/tests");
              console.log("  - Rollback plan (if applicable)");
            } else {
              console.log("‚úÖ PR description includes impact information");
            }
      
      - name: Summary
        if: steps.detect_class.outputs.requires_audit == 'true'
        run: |
          echo "üìã Audit Check Summary"
          echo "====================="
          echo "Change Class: ${{ steps.detect_class.outputs.change_class }}"
          echo "Audit Required: ${{ steps.detect_class.outputs.requires_audit }}"
          echo ""
          echo "‚úÖ Audit trail checks completed"
          echo ""
          echo "Note: Some checks are currently warnings, not hard failures."
          echo "This allows gradual adoption of the governance contract."
          echo "Future versions may enforce stricter requirements."
