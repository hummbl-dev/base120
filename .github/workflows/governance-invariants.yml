name: Governance Invariants

on:
  push:
    branches: [main]
  pull_request:
  workflow_dispatch:

permissions:
  contents: read

jobs:
  golden-corpus-determinism:
    name: Golden Corpus Determinism
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.13"

      - name: Install package with test deps
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[test]"

      - name: Run corpus tests (iteration 1)
        env:
          BASE120_FIXED_TIMESTAMP: "2026-01-01T00:00:00.000000Z"
        run: |
          pytest tests/test_corpus.py --json-report --json-report-file=/tmp/corpus_run1.json
          python -c "
import json
with open('/tmp/corpus_run1.json') as f:
    data = json.load(f)
# Extract deterministic fields only
results = {
    'summary': data['summary'],
    'tests': [
        {
            'nodeid': t['nodeid'],
            'outcome': t['outcome'],
            'call': t.get('call', {}).get('longrepr', '')
        }
        for t in data['tests']
    ]
}
with open('/tmp/corpus_run1_clean.json', 'w') as f:
    json.dump(results, f, sort_keys=True, indent=2)
" | cat
          echo "Run 1 completed"

      - name: Run corpus tests (iteration 2)
        env:
          BASE120_FIXED_TIMESTAMP: "2026-01-01T00:00:00.000000Z"
        run: |
          pytest tests/test_corpus.py --json-report --json-report-file=/tmp/corpus_run2.json
          python -c "
import json
with open('/tmp/corpus_run2.json') as f:
    data = json.load(f)
# Extract deterministic fields only
results = {
    'summary': data['summary'],
    'tests': [
        {
            'nodeid': t['nodeid'],
            'outcome': t['outcome'],
            'call': t.get('call', {}).get('longrepr', '')
        }
        for t in data['tests']
    ]
}
with open('/tmp/corpus_run2_clean.json', 'w') as f:
    json.dump(results, f, sort_keys=True, indent=2)
" | cat
          echo "Run 2 completed"

      - name: Run corpus tests (iteration 3)
        env:
          BASE120_FIXED_TIMESTAMP: "2026-01-01T00:00:00.000000Z"
        run: |
          pytest tests/test_corpus.py --json-report --json-report-file=/tmp/corpus_run3.json
          python -c "
import json
with open('/tmp/corpus_run3.json') as f:
    data = json.load(f)
# Extract deterministic fields only
results = {
    'summary': data['summary'],
    'tests': [
        {
            'nodeid': t['nodeid'],
            'outcome': t['outcome'],
            'call': t.get('call', {}).get('longrepr', '')
        }
        for t in data['tests']
    ]
}
with open('/tmp/corpus_run3_clean.json', 'w') as f:
    json.dump(results, f, sort_keys=True, indent=2)
" | cat
          echo "Run 3 completed"

      - name: Compare output hashes
        env:
          BASE120_FIXED_TIMESTAMP: "2026-01-01T00:00:00.000000Z"
        run: |
          HASH1=$(sha256sum /tmp/corpus_run1_clean.json | cut -d' ' -f1)
          HASH2=$(sha256sum /tmp/corpus_run2_clean.json | cut -d' ' -f1)
          HASH3=$(sha256sum /tmp/corpus_run3_clean.json | cut -d' ' -f1)
          
          echo "Run 1 hash: $HASH1"
          echo "Run 2 hash: $HASH2"
          echo "Run 3 hash: $HASH3"
          
          if [ "$HASH1" != "$HASH2" ] || [ "$HASH1" != "$HASH3" ]; then
            echo "❌ FAIL: Corpus outputs differ across runs"
            echo "This violates Invariant 1: Golden Corpus Determinism"
            exit 1
          fi
          
          echo "✅ PASS: All corpus runs produced identical output"
          echo "Golden Corpus Determinism verified."
